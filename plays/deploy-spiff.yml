---
- hosts: www
  sudo: True
  vars_files:
    - ../private/spiff-settings.yml
  tasks:
    - name: install packages
      action: yum pkg=$item state=latest
      with_items:
        - python-pip
        - python-virtualenv
        - mysql-devel
        - python-devel
        - gcc
    - name: deploy spiff
      action: git repo=git://github.com/SYNHAK/spiff.git dest=/srv/spiff/ version=HEAD
      notify:
      - reload wsgi
      - spiff syncdb
    - name: build spiff virtualenv
      action: command pip-python -E /srv/virtualenv/ install -r /srv/spiff/pip-requirements
    - name: install python-mysql to spiff virtualenv
      action: command pip-python -E /srv/virtualenv/ install MySQL-python
    - name: configure spiff
      action: template src=../config/local_settings.py dest=/srv/spiff/spiff/local_settings.py
  handlers:
    - name: reload wsgi
      action: command touch /srv/spiff/spiff/wsgi.py
    - name: spiff syncdb
      action: command /srv/spiff/manage.py syncdb --migrate --noinput
